#!/usr/bin/env python3

import os
import sys
import json
import argparse
from pathlib import Path

from multi_judge import MultiAgentCodeJudge


def collect_repo_files(root: Path) -> dict:
    files = {}
    for path in root.rglob("*.py"):
        if ".git" in path.parts or "__pycache__" in path.parts:
            continue
        try:
            files[str(path)] = path.read_text()
        except Exception:
            pass
    return files


def main():
    parser = argparse.ArgumentParser(description="Claude Gatekeeper AI")

    parser.add_argument("file", help="File or repo path")
    parser.add_argument("--json", action="store_true")
    parser.add_argument("--ci", action="store_true")
    parser.add_argument("--model", default="claude-sonnet-4-20250514")
    parser.add_argument("--profile", default="startup")
    parser.add_argument("--engine", default="v1")
    parser.add_argument("--gate", action="store_true", help="Run in repo gate mode")
    parser.add_argument("--no-cache", action="store_true")
    parser.add_argument("--no-meter", action="store_true")

    args = parser.parse_args()

    judge = MultiAgentCodeJudge(
        model=args.model,
        profile=args.profile,
        engine_version=args.engine,
        enable_cache=not args.no_cache,
        enable_metering=not args.no_meter,
    )

    target = Path(args.file)

    # -------- GATE MODE (THE PRODUCT) --------
    if args.gate:
        if target.is_file():
            files = {str(target): target.read_text()}
        else:
            files = collect_repo_files(target)

        gate = judge.gate_repo(files)
        print(json.dumps(gate, indent=2))
        sys.exit(0 if gate["gate_pass"] else 1)

    # -------- SINGLE FILE MODE --------
    code = target.read_text()
    result = judge.judge(code)

    if args.json or args.ci:
        print(json.dumps(result, indent=2))
        sys.exit(0 if result["policy_pass"] else 1)

    print("\n=== CLAUDE MULTI-AGENT CODE JUDGE ===\n")
    print("FILE:", args.file)
    print("MODEL:", args.model)
    print("PROFILE:", result["profile"])
    print("ENGINE:", result["engine_version"])
    print()
    print("OVERALL:", "PASS ✅" if result["overall_pass"] else "FAIL ❌")
    print("POLICY:", "PASS ✅" if result["policy_pass"] else "FAIL ❌")
    print("AVERAGE SCORE:", result["average_score"])
    print("THRESHOLD:", result["threshold"])
    print()

    if result["blocking_failures"]:
        print("BLOCKING FAILURES:", ", ".join(result["blocking_failures"]))
        print()

    for v in result["verdicts"]:
        print(f"[{v['agent'].upper()}]")
        print("PASS:", v["pass"])
        print("SCORE:", v["score"])
        print("SUMMARY:", v["summary"])
        if v["issues"]:
            print("ISSUES:")
            for i in v["issues"]:
                print(" -", i)
        print("-" * 50)

    sys.exit(0 if result["policy_pass"] else 1)


if __name__ == "__main__":
    main()
